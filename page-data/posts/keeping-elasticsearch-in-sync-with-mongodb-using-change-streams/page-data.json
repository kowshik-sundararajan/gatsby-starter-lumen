{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/keeping-elasticsearch-in-sync-with-mongodb-using-change-streams","result":{"data":{"markdownRemark":{"id":"36b02dbb-dd70-5805-9395-826faa5261ed","html":"<p>The ability to search and discover things is a must have feature in nearly every platform we use. When developers think about tackling search, the full-text search engine, <a href=\"https://www.elastic.co/what-is/elasticsearch\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Elasticsearch</a>, is often the first solution that comes to mind.</p>\n<p><img src=\"/media/posts/search.webp\" alt=\"search.webp\"></p>\n<p>The platform that I’m currently working on uses MongoDB for storage and retrieval. Search is optimised using the <a href=\"https://docs.mongodb.com/manual/reference/operator/query/text/#op._S_text\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">$text</code></a> operator. It works well for simple use cases but fails to account for typos, phrases and the overall accuracy and performance did not meet our expectations.</p>\n<p>To improve the search experience, I decided to integrate Elasticsearch into the platform for retrieval. One of the challenges with using two different data stores is keeping them in sync. Updates to MongoDB needed to be synced to Elasticsearch in near real-time.</p>\n<h2 id=\"mongo-change-streams\" style=\"position:relative;\"><a href=\"#mongo-change-streams\" aria-label=\"mongo change streams permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mongo Change Streams</h2>\n<p>I stumbled upon Mongo Change Streams which appeared to fit the use case perfectly. To utilize change streams, we must use a MongoDB replica set, reason being that the change stream works by using the oplog.</p>\n<p>My approach was to setup a background worker that listens to events emitted by the change stream and publish them to Elasticsearch.</p>\n<p>Opening a change stream against a collection is as simple as:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">db<span class=\"token punctuation\">.</span><span class=\"token function\">collection</span><span class=\"token punctuation\">(</span><span class=\"token string\">'person'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nPerson<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// directly using the model</span></code></pre></div>\n<h3 id=\"change-events\" style=\"position:relative;\"><a href=\"#change-events\" aria-label=\"change events permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Change Events</h3>\n<p>A change event typically has the following structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n   _id <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">&lt;</span><span class=\"token constant\">BSON</span> Object<span class=\"token operator\">></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n   <span class=\"token string\">\"operationType\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"&lt;operation>\"</span><span class=\"token punctuation\">,</span>\n   <span class=\"token string\">\"fullDocument\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">&lt;</span>document<span class=\"token operator\">></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n   <span class=\"token string\">\"ns\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"db\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"&lt;database>\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"coll\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"&lt;collection>\"</span>\n   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n   <span class=\"token string\">\"to\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"db\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"&lt;database>\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"coll\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"&lt;collection>\"</span>\n   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n   <span class=\"token string\">\"documentKey\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"_id\"</span> <span class=\"token operator\">:</span> <span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n   <span class=\"token string\">\"updateDescription\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"updatedFields\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">&lt;</span>document<span class=\"token operator\">></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"removedFields\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"&lt;field>\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">]</span>\n   <span class=\"token punctuation\">}</span>\n   <span class=\"token string\">\"clusterTime\"</span> <span class=\"token operator\">:</span> <span class=\"token operator\">&lt;</span>Timestamp<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n   <span class=\"token string\">\"txnNumber\"</span> <span class=\"token operator\">:</span> <span class=\"token operator\">&lt;</span>NumberLong<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n   <span class=\"token string\">\"lsid\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"id\"</span> <span class=\"token operator\">:</span> <span class=\"token operator\">&lt;</span><span class=\"token constant\">UUID</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"uid\"</span> <span class=\"token operator\">:</span> <span class=\"token operator\">&lt;</span>BinData<span class=\"token operator\">></span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">_id</code> contains the event identifier and is used for <a href=\"#resuming-a-change-stream\">resuming change streams</a></p>\n<p><code class=\"language-text\">fullDocument</code> contains a point-in-time snapshot of the document.</p>\n<p><code class=\"language-text\">documentKey</code> contains the <code class=\"language-text\">_id</code> of the document in the event.</p>\n<p><code class=\"language-text\">operationType</code> can be one of the following:</p>\n<ul>\n<li>insert: document is inserted</li>\n<li>update: document is updated</li>\n<li>replace: document is replaced</li>\n<li>delete: document is deleted</li>\n<li>drop: collection is dropped</li>\n<li>rename: collection is renamed</li>\n<li>dropDatabase: database is dropped</li>\n<li>invalidate: fired after a drop, rename or dropDatabase event</li>\n</ul>\n<p><code class=\"language-text\">update</code> events by default have the <code class=\"language-text\">updateDescription</code> field which indicates the fields that were updated or removed. If we want to get a point-in-time snapshot of the entire document, we have to specify the <code class=\"language-text\">updateLookup: &#39;fullDocument&#39;</code> option when opening the change stream.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  updateDocument<span class=\"token operator\">:</span> <span class=\"token string\">'fullLookup'</span>\n<span class=\"token punctuation\">}</span>\nPerson<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"filtering-change-events\" style=\"position:relative;\"><a href=\"#filtering-change-events\" aria-label=\"filtering change events permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Filtering change events</h3>\n<p>When opening a change stream, we can limit the number of events returned using an aggregation pipeline. This is extremely useful if we only care about certain types of events or data.</p>\n<p>Filtering for insert events</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> pipeline <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    $match<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      operationType<span class=\"token operator\">:</span> <span class=\"token string\">'insert'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span>\nPerson<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>pipeline<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Filtering for events that matche person documents with name = Jane</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> pipeline <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    $match<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">'fullDocument.name'</span><span class=\"token operator\">:</span> <span class=\"token string\">'Jane'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span>\nPerson<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>pipeline<span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"publishing-events-to-elasticsearch\" style=\"position:relative;\"><a href=\"#publishing-events-to-elasticsearch\" aria-label=\"publishing events to elasticsearch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Publishing events to Elasticsearch</h3>\n<p>Now comes the fun part. The <code class=\"language-text\">.watch()</code> function returns a change stream cursor that we can iterate over to retrieve events. We can then perform transformations on the event and publish them to Elasticsearch.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> pipeline <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> $match<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> operationType<span class=\"token operator\">:</span> <span class=\"token string\">'insert'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">const</span> changeStream <span class=\"token operator\">=</span> Person<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>pipeline<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>changeStream<span class=\"token punctuation\">.</span><span class=\"token function\">isExhausted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>changeStream<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> newEvent <span class=\"token operator\">=</span> changeStream<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// perform ES logic</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"resuming-a-change-stream\" style=\"position:relative;\"><a href=\"#resuming-a-change-stream\" aria-label=\"resuming a change stream permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resuming a change stream</h3>\n<p>With any technology, chances are they will fail at some point. Building fault-tolerant systems are part and parcel of a developer’s life. If a change stream terminates due to any reason, we can resume the stream from a certain point by using either the <code class=\"language-text\">startAfter</code> and <code class=\"language-text\">resumeAfter</code> option.</p>\n<p>Every change event has an <code class=\"language-text\">_id</code> which serves as the resume token. We can save this value in a quick access storage system like <a href=\"https://redis.io/topics/introduction\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">redis</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  startAfter<span class=\"token operator\">:</span> <span class=\"token function\">getResumeTokenFromRedis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> changeStream <span class=\"token operator\">=</span> Person<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>changeStream<span class=\"token punctuation\">.</span><span class=\"token function\">isExhausted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>changeStream<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> newEvent <span class=\"token operator\">=</span> changeStream<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// perform ES logic</span>\n    <span class=\"token function\">saveResumeTokenToCache</span><span class=\"token punctuation\">(</span>newEvent<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Change streams allow us to implement an application built on the <a href=\"https://en.wikipedia.org/wiki/Change_data_capture\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Change Data Capture (CDC)</a> design pattern where data changes are tracked and events are performed based on the changes.</p>\n<h2 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h2>\n<ul>\n<li><a href=\"https://docs.mongodb.com/manual/changeStreams/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MongoDB Change Streams</a></li>\n<li><a href=\"https://docs.mongodb.com/manual/reference/change-events/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MongoDB Change Events</a></li>\n<li><a href=\"https://docs.mongodb.com/manual/changeStreams/#resume-a-change-stream\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Resuming a change stream</a></li>\n</ul>","fields":{"slug":"/posts/keeping-elasticsearch-in-sync-with-mongodb-using-change-streams","tagSlugs":["/tag/mongo-db/","/tag/elasticsearch/","/tag/change-streams/"]},"frontmatter":{"date":"2020-08-24T18:00:00.000Z","description":"I decided to integrate Elasticsearch for retrieval to improve the search experience on a platform I'm working on. One of the challenges with using two different data stores is keeping them in sync. Updates to MongoDB needed to be synced to Elasticsearch in near real-time.","tags":["MongoDB","Elasticsearch","Change streams"],"title":"Keeping Elasticsearch in sync with MongoDB using Change Streams","socialImage":"/media/posts/search.webp"}}},"pageContext":{"slug":"/posts/keeping-elasticsearch-in-sync-with-mongodb-using-change-streams"}},"staticQueryHashes":["251939775","3942705351","401334301"]}