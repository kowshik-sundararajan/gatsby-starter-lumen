{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/mongodb-materialized-views","result":{"data":{"markdownRemark":{"id":"0e95e8a1-a51e-5f32-8180-0b01c9c4f9bf","html":"<p>A colleague of mine recently introduced the concept of <a href=\"https://en.wikipedia.org/wiki/Materialized_view\" title=\"materialized views\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">materialized views</a> in MongoDB to me and I thought it would be fun to write about it. Materialized views are not specific to MongoDB but for the purposes of this article, I won’t go beyond the scope of MongoDB.</p>\n<p><img src=\"/media/posts/database.png\" alt=\"database.png\"></p>\n<h3 id=\"what-are-materialized-views\" style=\"position:relative;\"><a href=\"#what-are-materialized-views\" aria-label=\"what are materialized views permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What are materialized views?</h3>\n<p>Essentially, materialized views are database objects containing the result of a query like the output of a Mongo aggregate query, for example. They come in handy when we want to quickly retrieve the output of aggregate queries joining several collections which are known to be slow in Mongo.</p>\n<h3 id=\"use-case\" style=\"position:relative;\"><a href=\"#use-case\" aria-label=\"use case permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use case</h3>\n<p>Let’s say you have a payment gateway product that powers millions of dollars of transactions and you’d like to display a counter of the total amount of transactions to date that has been made on your platform.</p>\n<p>One way to do this would be to run an aggregate query every time someone views your counter - this is slow and unnecessary. Instead, you could create a materialized view around the aggregate query and trigger it to run every day. The API can then serve the total amount by performing a simple find query which should be a lot faster.</p>\n<h3 id=\"how-do-you-create-a-materialized-view\" style=\"position:relative;\"><a href=\"#how-do-you-create-a-materialized-view\" aria-label=\"how do you create a materialized view permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How do you create a materialized view?</h3>\n<p>Materialized views are just like any other mongo collections. In our case, we wanted to create a materialized view to store the output of a complex aggregate query so added the <a href=\"https://docs.mongodb.com/manual/reference/operator/aggregation/merge/#mongodb-pipeline-pipe.-merge\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">$merge</a> stage as the last stage of the aggregate query to insert (first time) or update the collection. Depending on your use case you may want to run the aggregate query weekly, daily or every X seconds to update the materialized view.</p>\n<p>Created a mongoose schema for the materialized view:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> Schema <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> mongoose\n\n<span class=\"token keyword\">const</span> TransactionSummaryMaterializedViewSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Schema</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">{</span>\n    totalAmount<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> Number<span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      required<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> timestamps<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span> <span class=\"token string\">'TransactionSummary'</span><span class=\"token punctuation\">,</span> TransactionSummaryMaterializedViewSchema<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Aggregate query on the base model</p>\n<div class=\"gatsby-highlight\" data-language=\"javavscript\"><pre class=\"language-javavscript\"><code class=\"language-javavscript\">Transactions.aggregate([\n// lookups\n// unwinds\n// ... multiple stages,\n{\n\t$merge: { into: &#39;TransactionSummary&#39; }\n}\n])</code></pre></div>\n<p>Lastly, the API that would return the counter would perform this find query:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">TransactionSummary<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">.</span>totalAmount<span class=\"token punctuation\">)</span></code></pre></div>\n<p>There you go, a short introduction to MongoDB materialized views and what they can be used for.</p>\n<h2 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h2>\n<ul>\n<li><a href=\"https://docs.mongodb.com/manual/core/materialized-views/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">On-demand Materialized Views</a></li>\n</ul>","fields":{"slug":"/posts/mongodb-materialized-views","tagSlugs":["/tag/mongo-db/"]},"frontmatter":{"date":"2021-05-02T18:00:00.000Z","description":"A brief introduction to MongoDB Materialized Views that can help improve the performance of repetitive aggregate queries.","tags":["MongoDB"],"title":"MongoDB Materialized Views","socialImage":"/media/posts/search.webp"}}},"pageContext":{"slug":"/posts/mongodb-materialized-views"}},"staticQueryHashes":["251939775","3942705351","401334301"]}